<!DOCTYPE html>
<html lang="fr">

  <head>

    <link rel="icon" href="img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script type="text/javascript" src="app.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
    $(function(){
      $("#header").load("includes/header.html");
      $("#footer").load("includes/footer.html");
    });
    </script>

    <title>Nos coups de coeur</title>

  </head>

  <body class="light-theme">

    <div id="header"></div>

    <h2>Archives&nbsp;: Nos Coups de Coeur</h2>
    <h2>
      <input type="button" id="move_date_backward" class="button" value= "◀&#xFE0E;" style="color: var(--red);">
      <b><span id="date_of_today" class="center"></span></b>
      <input type="button" id="move_date_forward" class="button" value= "▶&#xFE0E;" style="color: var(--lightgrey);">
    </h2>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
      
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();
      var months_short_cap = ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Août', 'Septembre', 'Octobre', 'Novembre', 'Décembre'];
      var selected_date = new Date();          
      populate_month(db, selected_date);
      await check_if_isempty_and_change_date(selected_date);
      var first_date = new Date(selected_date.getFullYear(), selected_date.getMonth(), selected_date.getDate());
      populate_month(db, selected_date);
      
      async function populate_month(db, selected_date){
        document.getElementById("date_of_today").innerHTML = 
              months_short_cap[selected_date.getMonth()] + " " + String(selected_date.getFullYear());
        populate_review(db, selected_date);
      }

      async function populate_review(db, selected_date) {
        var selected_year = selected_date.getFullYear();
        var selected_month = selected_date.getMonth()+1;
        var year = selected_year.toString();
        var month = selected_month.toString().padStart(2, '0');
        const q = query(collection(db, "reviews"), where("year", "==", year), where("month", "==", month));
        var querySnapshot = await getDocs(q);
        var data = [];
        querySnapshot.forEach((doc) => {
          data.push(doc.data());
        });
        
        var string = ""
        data.sort((a, b) => $(b).attr('time') - $(a).attr('time')).forEach(f => {
          if(f.category == 'COUP DE C\u0152UR'){
            string = string.concat(
              "<div class='moviebox'>" +
                "<img src='data:image/png;base64," + f.image_file + "'/>" +
                "<h3 style='color:grey; font-weight:normal;'>" + week_string(string_to_date(f.date)) + "&nbsp;: " + f.category + "</h3>" +
                "<h3><i>" + f.movie_name + "</i>, " + f.movie_directors + " (" + f.movie_year + ")</h3>" +
                f.review +
              "</div><br>"
            )
          }
          document.getElementById("cdc").innerHTML = string
        });
      }

      async function move_date_forward() {
        if (!datesAreOnSameMonth(first_date, selected_date)){
          selected_date.setMonth(selected_date.getMonth() + 1);
          var tempScrollTop = $(window).scrollTop();
          document.getElementById("date_of_today").innerHTML = 
              months_short_cap[selected_date.getMonth()] + " " + String(selected_date.getFullYear());
          await $('#userdata tbody').empty();
          populate_review(db)
          $(window).scrollTop(tempScrollTop);
          document.getElementById("move_date_backward").style.color = "var(--red)";
          if (datesAreOnSameMonth(first_date, selected_date)){
            document.getElementById("move_date_forward").style.color = "var(--lightgrey)";  
          }
          else{
            document.getElementById("move_date_forward").style.color = "var(--red)";
          }
        }
      }

      async function check_if_isempty_and_change_date(date) {
        const q = query(collection(db, "reviews"), where("year", "==",  date.getFullYear().toString()), 
            where("month", "==", (date.getMonth()+1).toString().padStart(2, '0')));
        var querySnapshot = await getDocs(q);
        var data = [];
        querySnapshot.forEach((doc) => {
          data.push(doc.data());
        });
        if (data.length==0) {
          date.setMonth(date.getMonth() - 1);
        }
      }

      async function move_date_backward() {
        var selected_year = selected_date.getFullYear();
        var selected_month = selected_date.getMonth()+1;
        var aug2021 = new Date(2021, 8, 1);

        if (!datesAreOnSameMonth(aug2021, selected_date)){
          selected_date.setMonth(selected_date.getMonth() - 1);
          var tempScrollTop = $(window).scrollTop();
          document.getElementById("move_date_forward").style.color = "var(--red)";
          if (datesAreOnSameMonth(aug2021, selected_date)){
            document.getElementById("move_date_backward").style.color = "var(--lightgrey)";  
          }
          else{
            document.getElementById("move_date_backward").style.color = "var(--red)";
          }
          document.getElementById("date_of_today").innerHTML = 
              months_short_cap[selected_date.getMonth()] + " " + String(selected_date.getFullYear());
          await $('#userdata tbody').empty();
          populate_review(db)
          $(window).scrollTop(tempScrollTop);
        }
      }

      var moveForwardButton = document.querySelector('#move_date_forward');
      moveForwardButton.onclick = function() {
        move_date_forward()
      };

      var moveBackwardButton = document.querySelector('#move_date_backward');
      moveBackwardButton.onclick = function() {
        move_date_backward()
      };  
      

    </script>
    <span id="cdc"></span>
    <div id="footer"></div>
  </body>
</html>