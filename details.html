<!DOCTYPE html>
<html lang="fr">

  <head>

    <link rel="icon" href="img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script type="text/javascript" src="app.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
      $(function(){
        $("#header").load("includes/header.html");
        $("#footer").load("includes/footer.html");
      });
    </script>

  </head>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'

    const app = initializeApp(firebaseConfig);
    const db = getFirestore();

    var id = window.location.search;
    id = id.substring(4, id.length);
    console.log(id)

    async function get_review(db, id) {
      const q = query(collection(db, "reviews"), where("movie_id", "==", id));
      var querySnapshot = await getDocs(q);
      var data_aux = [];
      querySnapshot.forEach((doc) => {
        data_aux = doc.data();
      });
      return data_aux;
    }

    async function get_data(db, id) {
      const q = query(collection(db, "per_movie"), where("id", "==", id));
      var querySnapshot = await getDocs(q);
      var data_aux = [];
      querySnapshot.forEach((doc) => {
        data_aux = doc.data();
      });
      return data_aux;
    }

    function show_review(promise_review) {
      promise_review.then((data) => {
        document.getElementById("title").innerHTML = (
          "<b><i>" + data.title + "</b></i>, " +
          data.directors +
          " (" + data.year + ")"
        );
        document.getElementById("review_box").innerHTML = (
          "<div class='moviebox'>" +
            "<img src='data:image/png;base64," + data.image_file + "'/>" +
            data.review + "<br><br>" +
            "<div style='text-align:right'>Critique du " + day_string(string_to_date(data.date), false) + "</div>" +
          "</div><br>"
        );
      })
    }

    function show_next_sessions(db, id) {
      promise_data.then((data) => {
        document.getElementById("next-screenings-title").innerHTML = "Prochaines séances à Paris&nbsp;:"
        var next_screenings = "<div class='moviebox'>"
        const keys = Object.keys(data.screenings);
        keys.sort(
          (a, b) => a.localeCompare(b)
        ).forEach(f => {
          next_screenings += "<h3>" + day_string(string_to_date(f)) + "</h3>"
          next_screenings += display_showtimes(data.screenings[f], "<br>") + "<br><br>";
        })
        next_screenings += "</div>"
        document.getElementById("next-screenings").innerHTML = next_screenings;
      })
    }

    var promise_review = get_review(db, id);
    show_review(promise_review);
    var promise_data = get_data(db, id);
    console.log(promise_data)
    show_next_sessions(promise_data);

  </script>

  <body class="light-theme">
    <div id="header"></div>
    <h2><span id="title"></h2>
    <span id="review_box"></span>

    <h2><span id="next-screenings-title"></h2>
    <span id="next-screenings"></span>

    <div id="footer"></div>
  </body>

</html>
