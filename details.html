<!DOCTYPE html>
<html lang="fr">

  <head>
    <title>Détails du film | Le Rétro Projecteur – Cinéma de patrimoine à Paris</title>
    <link rel="icon" href="img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" CONTENT="Venez découvrir toutes les ressorties de films dans les salles parisiennes.">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.css"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.js"></script>
    <link rel="stylesheet" href="main.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
      $(function(){
        $("#header").load("includes/header.html");
        $("#footer").load("includes/footer.html");
      });
    </script>

    <script type="module">

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, collection, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();

      let today = date_to_string(new Date());
      let urlp = [];
      let s = location.toString().split('?')[1].split('&');
      for (let i = 0; i < s.length; i++) {
        urlp[s[i].split('=')[0]] = s[i].split('=')[1];
      }

      async function getData(db, id) {
        const q = query(collection(db, "website-by-movie-screenings"), where("id", "==", id));
        let querySnapshot = await getDocs(q);
        let data_aux = [];
        querySnapshot.forEach((doc) => {
          data_aux = doc.data();
        });
        return data_aux;
      }

      function show_info_and_screenings(promise_screenings) {
        promise_screenings.then((data) => {

          document.title = format_movie_title(data, null) + " | Le Rétro Projecteur – Cinéma de patrimoine à Paris";
          document.getElementById("title").innerHTML = format_movie_title(data, 'italic');

          let fiche_technique = ""
          if (data.original_title !== null){
            fiche_technique += "Titre original&nbsp;: <i>" + data.original_title +"</i><br/>";
          }
          if (!("duration" in data) || data.duration === "None"){
            fiche_technique += "Durée inconnue"
          } else {
            fiche_technique += "Durée&nbsp;: " + convert_duration(data.duration)
          }
          document.getElementById("fiche-technique").innerHTML = fiche_technique

          if (typeof data.review !== 'undefined') {
            document.getElementById("review_box").innerHTML = format_review(data, false, true, null)+"<br/>";
          }

          let next_screenings = "<div class='moviebox'>"
          next_screenings += "<h3>Prochaines séances à Paris&nbsp;:</h3><p style='line-height: 10px'></p>"
          data.screenings = Object.fromEntries(Object.entries(data.screenings).filter(([key]) => key>=today));
          let screenings = display_showtimes(data.screenings, "&nbsp;; ", true, "<p style='line-height: 10px'></p>")
          if (screenings.length === 0) {
            next_screenings += "<b>Pas de séance prévue pour le moment.<b>"
          } else {
            next_screenings += screenings
          }
          next_screenings += "</div>"
          console.log(next_screenings)
          document.getElementById("next-screenings").innerHTML = next_screenings;

        })
      }

      let promise_screenings = getData(db, urlp['id']);
      show_info_and_screenings(promise_screenings);

    </script>

  </head>

  <body class="light-theme">
    <div id="header"></div>
    <h2><span id="title"></span></h2>
    <div style="text-align: center;"><span id="fiche-technique"></span></div>
    <br/>
    <span id="review_box"></span>
    <span id="next-screenings"></span>
    <div id="footer"></div>
  </body>

</html>
