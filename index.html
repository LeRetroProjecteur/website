<!DOCTYPE html>
<html lang="fr">

  <head>
    <link rel="icon" href="img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script src="jquery.ui.touch-punch.min.js"></script>
    <script type="text/javascript" src="app.js"></script>
    

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
    $(function(){
      $("#header").load("includes/header.html");
      $("#footer").load("includes/footer.html");
    });
    </script>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
      // TO DO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();

      var selected_date = new Date();
      var selected_start_hour = selected_date.getHours()-1;
      var selected_end_hour = 24;
      var day = selected_date.getUTCDate();
      var promise_data = [];

      async function get_data(db, date){
        var todayString = date_to_string(date);
        const q = query(collection(db, "movies"), where("date", "==", todayString));
        var querySnapshot = await getDocs(q);
        var data_aux = [];
        querySnapshot.forEach((doc) => {
          data_aux = doc.data().movies;
        });
        return data_aux;
      }

      async function populate_movies(promise_data, date, start, end) {
        var tempScrollTop = $(window).scrollTop();
        await $('#userdata tbody').empty();
        var nd = new Date();
        if (datesAreOnSameDay(date, nd)){
          var day_hour = nd.getHours()-1;
        } else {
          var day_hour = 0;
        }
        start = Math.max(start, day_hour);

        promise_data.then((data) => {
          data.sort(
            (a, b) => $(a).attr('year') - $(b).attr('year') || $(a).attr('directors').localeCompare($(b).attr('directors')) || $(a).attr('title').localeCompare($(b).attr('title'))
          ).forEach(f => {
            var md = new Date(f.date[0], f.date[1]-1, f.date[2]);
            var mdStr = String(md.getFullYear()).concat('-', String(md.getMonth()+1), '-', String(md.getDate()));
            var sdStr = String(selected_date.getFullYear()).concat('-', String(selected_date.getMonth()+1), '-', String(selected_date.getDate()));
            var new_dict = display_real_dict(f.showtimes_theater, start, end);

            if (mdStr==sdStr && Object.keys(new_dict).length > 0) {
              var real_showtime = display_showtimes(new_dict);
              var movie_page = f.title
              var tblRow = "<tr>" +
                "<td><b>" + movie_page + "</b> (" + f.directors + ", " + f.year + ")" + "</td>" +
                "<td>" + real_showtime + "</td>" +
                "</tr>"
              $(tblRow).appendTo("#userdata tbody");
            }
          });
        $(window).scrollTop(tempScrollTop);
        })
      }

      async function refresh_data() {
        populate_movies(promise_data, selected_date, selected_start_hour, selected_end_hour);
      }

      async function move_date_forward() {
        selected_start_hour = 0;
        selected_end_hour = 24;
        $("#slider-range").slider('values',0, 0);
        $("#slider-range").slider('values',1, 24);
        document.getElementById("time-span").innerHTML = (
          "Séances entre <b style='color:var(--red); font-weight:bold;'>" +
          $("#slider-range").slider("values", 0) + "h et " + $("#slider-range").slider("values", 1) + "h </b>"
        )
        selected_date.setDate(selected_date.getDate()+1);
        document.getElementById("date_of_today").innerHTML = day_string(selected_date);
        document.getElementById("move_date_backward").style.color = "var(--red)";
        promise_data = get_data(db, selected_date);
        refresh_data();
      }

      async function move_date_backward() {
        selected_start_hour = 0;
        selected_end_hour = 24;
        $("#slider-range").slider('values',0, 0);
        $("#slider-range").slider('values',1, 24);
        document.getElementById("time-span").innerHTML = (
          "Séances entre <b style='color:var(--red); font-weight:bold;'>" +
          $("#slider-range").slider("values", 0) + "h et " + $("#slider-range").slider("values", 1) + "h </b>"
        )
        var nd = new Date();
        if (!datesAreOnSameDay(nd, selected_date)){
          selected_date.setDate(selected_date.getDate()-1);
          document.getElementById("date_of_today").innerHTML = day_string(selected_date);
          if (datesAreOnSameDay(nd, selected_date)) {
            document.getElementById("move_date_backward").style.color = "var(--lightgrey)";
          } else {
            document.getElementById("move_date_backward").style.color = "var(--red)";
          }
          promise_data = get_data(db, selected_date);
          refresh_data();
        }
      }

      $( function() {
        $("#slider-range").slider({
          range: true,
          min: 0,
          max: 24,
          values: [0, 24],
          slide: function(event, ui) {
            document.getElementById("time-span").innerHTML = (
              "Séances entre <b style='color:var(--red); font-weight:bold;'>" +
              ui.values[0] + "h et " + ui.values[1] + "h </b>"
            )
            populate_movies(promise_data, selected_date, ui.values[0], ui.values[1]);
          }
        });
      });

      var moveForwardButton = document.querySelector('#move_date_forward');
      moveForwardButton.onclick = function() {
        move_date_forward()
      };

      var moveBackwardButton = document.querySelector('#move_date_backward');
      moveBackwardButton.onclick = function() {
        move_date_backward()
      };

      (async () => {
        $(function() {
          document.getElementById("date_of_today").innerHTML = day_string(selected_date);
          document.getElementById("time-span").innerHTML = (
            "Séances entre <b style='color:var(--red); font-weight:bold;'>" +
            $("#slider-range").slider("values", 0) + "h et " + $("#slider-range").slider("values", 1) + "h </b>"
          )
          promise_data = get_data(db, selected_date);
          refresh_data();
        });
      })();
    </script>


    <title>Up Close | Cinéma à Paris</title>

  </head>

  <body class="light-theme">
    <div id="header"></div>
    <h3>
      <input type="button" id="move_date_backward" class="button" value= "◀&#xFE0E;" style="color: var(--lightgrey);">
      <b><span id="date_of_today" class="center"></span></b>
      <input type="button" id="move_date_forward" class="button" value= "▶&#xFE0E;" style="color: var(--red);">
    </h3>
    <brsmall>
    <center>

      <span id="time-span" class="center"></span>
      <div id="slider-range"></div>
      <br>

    </center>
    <brsmall>

    <div class="wrapper">
    <div class="profile">
      <table id= "userdata" border="2" class="center">
      <thead>
        <th style="width:50%;background-color:var(--red);color:var(--white);">Film</th>
        <th style="width:50%;background-color:var(--red);color:var(--white);">Séances</th>
      </thead>
      <tbody>
      </tbody>
      </table>
    </div>
    </div>

    <div id="footer"></div>
  </body>
</html>
