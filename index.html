<!DOCTYPE html>
<html lang="fr" xmlns="http://www.w3.org/1999/xhtml">

  <head>

    <title>Calendrier | Le Rétro Projecteur – Cinéma de patrimoine à Paris</title>
    <meta name="Description" CONTENT="Venez découvrir toutes les ressorties de films dans les salles parisiennes.">
    <meta name="keywords" content="ressorties film paris cinema patrimoine salles parisiennes">
    <meta property="og:image" content="/img/logo_square.png">

    <link rel="icon" href="/img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.css"/>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script type="text/javascript" src="/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.js"></script>
    <link rel="stylesheet" href="/main.css">
    <script>
      $(function() {
        $("#header").load("/includes/header.html");
        $("#footer").load("/includes/footer.html");
      });
    </script>

    <script type="module">

      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, collection, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();

      let promiseData = [];
      let filteringBox = document.getElementById("filtering-box");
      let filteringTerm = "";
      let slider = document.getElementById('slider-range');
      let startTime = 0;
      let endTime = 24;
      let neighborhoodDropdown = document.getElementById('neighborhood-list');
      let checkedNeighborhoods = ['rg', 'rd', 'em']

      let selectedDate = new Date();
      document.getElementById("date-of-today").innerHTML = dayString(selectedDate);

      async function getData(db, date, promiseData) {
        console.log("Fetching data")
        const q = query(collection(db, "website-by-date-screenings"), where("date", "==", dateToString(date)));
        let querySnapshot = await getDocs(q);
        promiseData = appendData(promiseData, querySnapshot, date)
      }

      async function populateMovies(promiseData, startTime, endTime, filteringTerm, checkedNeighborhoods) {
        console.log("Populating table")
        await $('#userdata tbody').empty();
        let [oneShown, oneStillPlaying, oneContainsFilteringTerm] = [false, false, false];

        promiseData.flat(1).sort(
          (a, b) => $(a).attr('year')-$(b).attr('year')
          || $(a).attr('directors').localeCompare($(b).attr('directors'))
          || $(a).attr('title').localeCompare($(b).attr('title'))
        ).forEach(f => {
          let [shown, stillPlaying, containsFilteringTerm] = generateDataRow(
            f, startTime, endTime, filteringTerm, checkedNeighborhoods
          );
          oneShown = (oneShown || shown);
          oneStillPlaying = (oneStillPlaying || stillPlaying);
          oneContainsFilteringTerm = (oneContainsFilteringTerm || containsFilteringTerm);
        });
        if (oneShown===false) {
          if (oneStillPlaying===false) {
            let tblRow = "<tr><td colspan='100%'>" + noMoviePlayingAtThisHour + "</td></tr>";
            $(tblRow).appendTo("#userdata tbody");
          } else {
            let tblRow = "<tr><td colspan='100%'>" + noMovieForFilteringTerm + "</td></tr>";
            $(tblRow).appendTo("#userdata tbody");
          }
        }
      }

      function refreshData() {
        startTime = updateStartTime(startTime, selectedDate)
        populateMovies(promiseData, startTime, endTime, filteringTerm, checkedNeighborhoods);
      }

      $(async function() {
        promiseData = [];
        await getData(db, selectedDate, promiseData);
        refreshData();
      });

      // Slider
      slider = formatSlider(slider);
      slider.noUiSlider.on('update', function() {
        [startTime, endTime] = updateSlider(startTime, endTime)
      });
      slider.noUiSlider.on('change', function() {
        refreshData();
      });

      // Neighborhood dropdown
      neighborhoodDropdown.getElementsByClassName('anchor')[0].onclick = function() {
        if (neighborhoodDropdown.classList.contains('visible')) {
          neighborhoodDropdown.classList.remove('visible');
        }
        else {
          neighborhoodDropdown.classList.add('visible');
        }
      }
      $('*').on("click", function(evt) {
        if (!$(evt.target).hasClass('anchor') & !$(evt.target).hasClass('checkbox') && !$(evt.target).hasClass('items')) {
          neighborhoodDropdown.classList.remove('visible');
        }
      });
      $(':checkbox').on("click", function() {
        checkedNeighborhoods = []
        $("input:checkbox:checked").each(function() {
          checkedNeighborhoods.push($(this)[0].id);
        });
        refreshData();
      });

      // Filtering function
      filteringBox.addEventListener('keyup', () => {
        filteringTerm = filteringBox.value;
        refreshData();
      });

      // Date change
      let dateBackwardButton = document.querySelector('#date-backward');
      dateBackwardButton.onclick = async function() {
        selectedDate = moveDateBackward(selectedDate, slider)
        promiseData = [];
        await getData(db, selectedDate, promiseData);
        refreshData();
      };
      let dateForwardButton = document.querySelector('#date-forward');
      dateForwardButton.onclick = async function() {
        selectedDate = moveDateForward(selectedDate, slider)
        promiseData = [];
        await getData(db, selectedDate, promiseData);
        refreshData();
      };

    </script>

  </head>

  <body class="light-theme">
    <div id="header"></div>
    <h3>
      <input type="button" id="date-backward" class="button" value= "◀&#xFE0E;" style="color: var(--lightgrey);">
      <b><span id="date-of-today"></span></b>
      <input type="button" id="date-forward" class="button" value= "▶&#xFE0E;" style="color: var(--red);">
    </h3>
    <p style="margin: 7px;"></p>
    <div style="text-align: center;">
      <div id="slider-range-value"></div>
      <div class="slider-styled" id="slider-range"></div>
      <p style="margin: 7px;"></p>
      <div id="wrap">
        <div id="neighborhood-list" class="dropdown-check-list" tabindex="100">
          <span class="anchor">Par quartiers</span>
          <ul class="items">
            <label class="checkbox"><input class="checkbox" type="checkbox" id="rg" checked> Rive gauche<br/></label>
            <label class="checkbox"><input class="checkbox" type="checkbox" id="rd" checked> Rive droite<br/></label>
            <label class="checkbox"><input class="checkbox" type="checkbox" id="em" checked> Extra-muros<br/></label>
          </ul>
        </div>
        <div class="filtering">
          <label for="filtering-box"></label><input type="text" class="filtering-box" id="filtering-box" placeholder="Réalisateur, pays...">
        </div>
      </div>
    </div>
    <p style="margin: 7px;"></p>
    <div class="wrapper">
      <div class="profile">
        <table id= "userdata" class="center">
          <thead>
            <tr>
              <th style="width:50%;background-color:var(--red);color:var(--white);"><strong>Film</strong></th>
              <th style="width:50%;background-color:var(--red);color:var(--white);"><strong>Séances</strong></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div id="footer"></div>
  </body>

</html>