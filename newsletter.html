<!DOCTYPE html>
<html lang="fr">

  <head>

    <link rel="icon" href="img/logo_square.png" , alt="Cinéma à Paris">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" CONTENT="Venez découvrir notre newsletter hebdomadaire contenant notre sélection de films.">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.css" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.js"></script>
    <script type="text/javascript" src="app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.4.0/nouislider.min.js"></script>
    <link rel="stylesheet" href="main.css">

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
      $(function(){
        $("#header").load("includes/header.html");
        $("#footer").load("includes/footer.html");
      });
    </script>

  </head>

  <body class="light-theme">

    <div id="header"></div>

    <h2>Que voir à Paris cette semaine&nbsp;?</h2>

    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
      import { getFirestore, collection, doc, getDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
      // TO DO: Add SDKs for Firebase products that you want to use
      // https://firebase.google.com/docs/web/setup#available-libraries

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore();

      async function get_newsletter_dates_list(db) {
        const am = doc(db, "newsletters", "all_dates");
        var querySnapshot = await getDoc(am);
        return querySnapshot.data();
      };
      function show_newsletter(db, promise_dates){
        promise_dates.then((data) => {
          var date = data[Object.keys(data)[Object.keys(data).length - 1]];
          document.getElementById("week").innerHTML = newsletter_week(date);
          show_newsletter_content(db, date);
        })
      };
      async function show_newsletter_content(db, date) {
        const q = query(collection(db, "newsletters"), where("date", "==", date));
        var querySnapshot = await getDocs(q);
        var cinema_weeks = "";
        var intro = "";
        querySnapshot.forEach((doc) => {
          var f = doc.data()
          intro = format_intro(f)
          cinema_weeks = cinema_weeks.concat(format_cinema_week(f))
          show_review(db, f.cdc, 'cdc', f.cdc_showtimes)
          show_review(db, f.curio, 'curio', f.curio_showtimes)
        });
        document.getElementById("intro").innerHTML = intro;
        document.getElementById("cinema-weeks").innerHTML = cinema_weeks;
      };
      async function show_review(db, id, type, showtimes){
        const q = query(collection(db, "reviews"), where("id", "==", id))
        var querySnapshot = await getDocs(q);
        var review = "";
        querySnapshot.forEach((doc) => {
          var f = doc.data();
          review = format_review(f, showtimes);
        });
        document.getElementById(type).innerHTML = review;
      }

      var promise_dates = get_newsletter_dates_list(db);
      show_newsletter(db, promise_dates);

    </script>

    <h3><span id="week"></span></h3>
    <br>
    <span id="intro"></span>
    <span id="cdc"></span>
    <span id="curio"></span>
    <span id="cinema-weeks"></span>
    <div id="footer"></div>

  </body>

</html>
