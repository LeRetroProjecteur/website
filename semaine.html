<!DOCTYPE html>
<html lang="fr">

  <head>

    <link rel="icon" href="img/logo_square.png">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"> </script>
    <script type="text/javascript" src="app.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-F5QY5F8S5L"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-F5QY5F8S5L');
    </script>

    <script>
    $(function(){
      $("#header").load("includes/header.html");
      $("#footer").load("includes/footer.html");
    });
    </script>

    <title>La semaine prochaine</title>

  </head>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.2/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, getDocs, query, where  } from 'https://www.gstatic.com/firebasejs/9.6.2/firebase-firestore.js'
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCjvHHSqWGZhh2pcoHF_8ZeKqxT0wRvXuc",
      authDomain: "website-cine.firebaseapp.com",
      projectId: "website-cine",
      storageBucket: "website-cine.appspot.com",
      messagingSenderId: "1060388636946",
      appId: "1:1060388636946:web:ea3752ae94d0ab56e68bcb"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore();

    var date = new Date();
    var delta = date.getDay()-3;
    date.setDate(date.getDate() - delta);
    document.getElementById("current_week").innerHTML = week_string(get_current_week(date)[0]);
    //var todayString = String(date.getFullYear()).concat('_', String(date.getMonth()+1), '_', String(date.getDate()));
    //console.log(todayString)
    
    async function populate_movies_week(date) {
        var todayString = date_to_string(date);
        var data = [];
        for (let i = 0; i < 7; i++) {
          var string_date = date_to_string(date);
          await populate_movies_day(data, string_date);
          date.setDate(date.getDate() + 1);
        }
        const data_flat = data.flat(1);
        create_string(data_flat);
    }
    
    async function populate_movies_day(data, date) {
      const q = query(collection(db, "movies"), where("date", "==", date));
      var querySnapshot = await getDocs(q);
      var data_day = [];
      querySnapshot.forEach((doc) => {
        data_day = doc.data().movies;
      });
      data.push(data_day);
    }
    
    (async () => {
        $(function() {
          populate_movies_week(date);
        });
      })();
    
    function create_string(data){
      var prev_movie = "";
      var string = "";
      data.sort((a, b) => $(a).attr('year') - $(b).attr('year')).forEach(f => {
        var movie = f.date;
        var md = new Date(movie[0], movie[1]-1, movie[2], 0, 0, 0, 0)
        var max_hour = display_real_dict(f.showtimes_theater)[0];
        var new_dict = display_real_dict(f.showtimes_theater)[1];
        var real_showtime = display_showtimes(new_dict, "; ");
        
        if (f.title != prev_movie){
          string = string.concat(
            "<br><h3 style='text-align:left'><i>" + f.title + "</i>, " + f.directors + " (" + f.year + ")</h3>"
          )
        }
        string = string.concat(
          "<b>" + days_short[md.getDay()] + " " + md.getDate() + " " + months_short[md.getMonth()] + "</b> " +
          real_showtime + "<br>"
        )
        prev_movie = f.title;
      });
      document.getElementById("week_films").innerHTML = string;
    }

  </script>

  <body class="light-theme">

    <div id="header"></div>
    <h3><span id="current_week"></span></h3>
    <h2><span id="next_week"></span></h2>
    <span id="week_films"></span>

    <div id="footer"></div>

  </body>
</html>
